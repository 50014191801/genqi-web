// GenQi Sabah Intake App - Single-file MVP
// 技术：React + Tailwind + supabase-js（浏览器端使用 anon key）
// 用途：
// 1) 公网顾客自助填写问诊表（/intake）
// 2) 店内员工使用 Admin 区域（登录后）可搜索/查看/追踪顾客档案
// 3) 可新增回访记录（Visits）与上传舌象/脉象图片（Supabase Storage）
//
// ⚙️ 上线前配置（必读）：
// - 新建 Supabase Project，拷贝 Project URL 与 anon 公钥到 .env（或临时粘贴至下方 env 占位）
// - SQL 建表与 RLS（复制到 Supabase SQL Editor 运行）：
// -------------------------------------------------------------
// -- schema: public
// create table if not exists customers (
//   id uuid primary key default gen_random_uuid(),
//   full_name text not null,
//   phone text,
//   gender text,
//   age int,
//   created_at timestamp with time zone default now(),
//   updated_at timestamp with time zone default now()
// );
// create table if not exists visits (
//   id uuid primary key default gen_random_uuid(),
//   customer_id uuid references customers(id) on delete cascade,
//   visit_date date default current_date,
//   symptoms text,
//   bowel text,
//   urine text,
//   sleep text,
//   thirst text,
//   tongue text,
//   pulse text,
//   body_feel text,
//   menstrual text,
//   notes text,
//   created_at timestamp with time zone default now()
// );
// -- 开启 RLS
// alter table customers enable row level security;
// alter table visits enable row level security;
// -- 匿名可插入数据（顾客自助提交）
// create policy "anon_insert_customers" on customers
//   for insert to anon with check (true);
// create policy "anon_insert_visits" on visits
//   for insert to anon with check (true);
// -- 登录用户可读写全部（店内员工账号）
// create policy "auth_full_access_customers" on customers
//   for all to authenticated using (true) with check (true);
// create policy "auth_full_access_visits" on visits
//   for all to authenticated using (true) with check (true);
// -------------------------------------------------------------
// - Storage: 建 bucket name = "uploads"，Public
// - Auth: 启用 Email/Password，创建店员账户（如 admin@sabah.genqi.vip ）
// - 部署：推荐 Vercel，绑定自定义域 sabah.genqi.vip（DNS CNAME 到 Vercel）
// ----------------------------------------------

import React, { useEffect, useMemo, useState } from "react";
import { createClient } from "@supabase/supabase-js";

// ====== 1) 环境变量占位（部署到 Vercel 时使用环境变量，不要写死） ======
const SUPABASE_URL = (globalThis as any).env?.SUPABASE_URL || "https://YOUR-PROJECT.supabase.co";
const SUPABASE_ANON_KEY = (globalThis as any).env?.SUPABASE_ANON_KEY || "YOUR-ANON-KEY";

// ====== 2) 初始化 Supabase 客户端 ======
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ====== 3) UI 小组件 ======
function Section({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <div className="bg-white/80 backdrop-blur border rounded-2xl shadow p-6 mb-6">
      <h2 className="text-xl font-semibold mb-4">{title}</h2>
      {children}
    </div>
  );
}

function Input({ label, ...props }: React.InputHTMLAttributes<HTMLInputElement> & { label?: string }) {
  return (
    <label className="block mb-3">
      {label && <span className="block text-sm text-gray-600 mb-1">{label}</span>}
      <input
        className="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-900/20"
        {...props}
      />
    </label>
  );
}

function Textarea({ label, ...props }: React.TextareaHTMLAttributes<HTMLTextAreaElement> & { label?: string }) {
  return (
    <label className="block mb-3">
      {label && <span className="block text-sm text-gray-600 mb-1">{label}</span>}
      <textarea
        className="w-full rounded-xl border px-3 py-2 h-24 focus:outline-none focus:ring-2 focus:ring-gray-900/20"
        {...props}
      />
    </label>
  );
}

// ====== 4) Intake 表单（公网） ======
function IntakeForm({ onSaved }: { onSaved?: (payload: { customerId: string; visitId: string }) => void }) {
  const [form, setForm] = useState({
    full_name: "",
    phone: "",
    gender: "",
    age: "",
    symptoms: "",
    bowel: "",
    urine: "",
    sleep: "",
    thirst: "",
    tongue: "",
    pulse: "",
    body_feel: "",
    menstrual: "",
    notes: "",
  });
  const [submitting, setSubmitting] = useState(false);
  const [ok, setOk] = useState<null | string>(null);
  const [err, setErr] = useState<null | string>(null);

  const update = (k: string, v: string) => setForm((s) => ({ ...s, [k]: v }));

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSubmitting(true);
    setOk(null);
    setErr(null);
    try {
      if (!form.full_name) throw new Error("请填写姓名");
      // 1) 建立/插入 customers
      const { data: cust, error: e1 } = await supabase
        .from("customers")
        .insert({
          full_name: form.full_name,
          phone: form.phone,
          gender: form.gender,
          age: form.age ? Number(form.age) : null,
        })
        .select()
        .single();
      if (e1) throw e1;
      // 2) 插入 visit 首次问诊
      const { data: visit, error: e2 } = await supabase
        .from("visits")
        .insert({
          customer_id: cust.id,
          symptoms: form.symptoms,
          bowel: form.bowel,
          urine: form.urine,
          sleep: form.sleep,
          thirst: form.thirst,
          tongue: form.tongue,
          pulse: form.pulse,
          body_feel: form.body_feel,
          menstrual: form.menstrual,
          notes: form.notes,
        })
        .select()
        .single();
      if (e2) throw e2;
      setOk("提交成功，我们已收到您的资料！");
      onSaved?.({ customerId: cust.id, visitId: visit.id });
      setForm({
        full_name: "",
        phone: "",
        gender: "",
        age: "",
        symptoms: "",
        bowel: "",
        urine: "",
        sleep: "",
        thirst: "",
        tongue: "",
        pulse: "",
        body_feel: "",
        menstrual: "",
        notes: "",
      });
    } catch (e: any) {
      setErr(e?.message || String(e));
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <Section title="GenQi Sabah — 首诊资料表 (公共)">
      <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Input label="姓名*" placeholder="例如：Alex Tay" value={form.full_name} onChange={(e) => update("full_name", e.target.value)} />
        <Input label="电话" placeholder="WhatsApp" value={form.phone} onChange={(e) => update("phone", e.target.value)} />
        <Input label="性别" placeholder="男/女" value={form.gender} onChange={(e) => update("gender", e.target.value)} />
        <Input label="年龄" placeholder="例如：38" value={form.age} onChange={(e) => update("age", e.target.value)} />

        <Textarea label="主要症状 + 诱因（时间线、晨晚差异）" value={form.symptoms} onChange={(e) => update("symptoms", e.target.value)} />
        <Textarea label="大便（频率/性状）" value={form.bowel} onChange={(e) => update("bowel", e.target.value)} />
        <Textarea label="小便（频次/颜色/不尽感/气味）" value={form.urine} onChange={(e) => update("urine", e.target.value)} />
        <Textarea label="睡眠（入睡难/夜醒点/醒后状态）" value={form.sleep} onChange={(e) => update("sleep", e.target.value)} />
        <Textarea label="口渴/口苦/喜冷喜热" value={form.thirst} onChange={(e) => update("thirst", e.target.value)} />
        <Textarea label="舌（色/苔/胖瘦/齿痕/润燥/舌底血管）" value={form.tongue} onChange={(e) => update("tongue", e.target.value)} />
        <Textarea label="脉（寸关尺强弱/浮沉/数缓/涩滑）" value={form.pulse} onChange={(e) => update("pulse", e.target.value)} />
        <Textarea label="体感（怕冷或热/汗/胸闷胀满/头晕顶闷/脚底温度）" value={form.body_feel} onChange={(e) => update("body_feel", e.target.value)} />
        <Textarea label="月经（周期/经量/颜色/质地/伴随症状）" value={form.menstrual} onChange={(e) => update("menstrual", e.target.value)} />
        <Textarea label="备注 / 其他" value={form.notes} onChange={(e) => update("notes", e.target.value)} />

        <div className="col-span-full flex items-center gap-3">
          <button disabled={submitting} className="rounded-xl px-4 py-2 bg-black text-white hover:opacity-90 disabled:opacity-50">
            {submitting ? "提交中…" : "提交"}
          </button>
          {ok && <span className="text-green-600">{ok}</span>}
          {err && <span className="text-red-600">{err}</span>}
        </div>
      </form>
    </Section>
  );
}

// ====== 5) Admin（店内）登录 + 搜索/查看 ======
function AdminPanel() {
  const [session, setSession] = useState<any>(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [search, setSearch] = useState("");
  const [rows, setRows] = useState<any[]>([]);
  const [busy, setBusy] = useState(false);

  useEffect(() => {
    const { data: sub } = supabase.auth.onAuthStateChange((_evt, sess) => setSession(sess));
    supabase.auth.getSession().then(({ data }) => setSession(data.session));
    return () => sub.subscription.unsubscribe();
  }, []);

  const login = async () => {
    setBusy(true);
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    setBusy(false);
    if (error) alert(error.message);
  };
  const logout = async () => {
    await supabase.auth.signOut();
  };

  const runSearch = async () => {
    setBusy(true);
    try {
      let q = supabase.from("customers").select("*, visits(id, visit_date, symptoms, notes)").order("updated_at", { ascending: false });
      if (search.trim()) {
        // 简单模糊：姓名/电话
        q = q.or(`full_name.ilike.%${search}%,phone.ilike.%${search}%`);
      }
      const { data, error } = await q.limit(100);
      if (error) throw error;
      setRows(data || []);
    } catch (e: any) {
      alert(e.message || String(e));
    } finally {
      setBusy(false);
    }
  };

  const [newVisit, setNewVisit] = useState({ symptoms: "", notes: "" });
  const addVisit = async (customerId: string) => {
    if (!newVisit.symptoms && !newVisit.notes) return;
    const { error } = await supabase.from("visits").insert({ customer_id: customerId, symptoms: newVisit.symptoms, notes: newVisit.notes });
    if (error) return alert(error.message);
    setNewVisit({ symptoms: "", notes: "" });
    runSearch();
  };

  if (!session) {
    return (
      <Section title="Admin 登录（店员使用）">
        <div className="max-w-md">
          <Input label="邮箱" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="admin@sabah.genqi.vip" />
          <Input label="密码" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="••••••••" />
          <button onClick={login} disabled={busy} className="rounded-xl px-4 py-2 bg-black text-white hover:opacity-90 disabled:opacity-50">{busy ? "登录中…" : "登录"}</button>
        </div>
      </Section>
    );
  }

  return (
    <Section title="顾客档案（可查询 / 可追踪）">
      <div className="flex items-center gap-3 mb-4">
        <Input placeholder="搜索姓名或电话…" value={search} onChange={(e) => setSearch(e.target.value)} />
        <button onClick={runSearch} className="rounded-xl px-4 py-2 bg-black text-white">查询</button>
        <button onClick={logout} className="rounded-xl px-4 py-2 border">退出</button>
      </div>
      <div className="grid gap-4">
        {rows.map((c) => (
          <div key={c.id} className="border rounded-xl p-4">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div className="font-semibold text-lg">{c.full_name} <span className="text-sm text-gray-500">#{c.id.slice(0,8)}</span></div>
                <div className="text-sm text-gray-600">{c.phone} • {c.gender || "-"} • {c.age ? `${c.age}岁` : "年龄-"}</div>
              </div>
              <div className="text-xs text-gray-500">建档：{new Date(c.created_at).toLocaleString()}</div>
            </div>

            <div className="mt-3">
              <div className="text-sm font-medium mb-1">新增回访记录</div>
              <div className="grid md:grid-cols-2 gap-2">
                <Textarea placeholder="本次症状/主诉…" value={newVisit.symptoms} onChange={(e) => setNewVisit((s) => ({ ...s, symptoms: e.target.value }))} />
                <Textarea placeholder="治疗/方剂/艾灸/饮食/备注…" value={newVisit.notes} onChange={(e) => setNewVisit((s) => ({ ...s, notes: e.target.value }))} />
              </div>
              <button onClick={() => addVisit(c.id)} className="mt-2 rounded-xl px-3 py-1.5 bg-black text-white">保存回访</button>
            </div>

            <div className="mt-4">
              <div className="text-sm font-medium mb-1">历史就诊</div>
              <div className="grid gap-2">
                {(c.visits || []).map((v: any) => (
                  <div key={v.id} className="rounded-lg border p-3 text-sm">
                    <div className="text-gray-600">{v.visit_date} • 记录#{v.id.slice(0,6)}</div>
                    {v.symptoms && <div className="mt-1"><span className="font-medium">症状：</span>{v.symptoms}</div>}
                    {v.notes && <div className="mt-1"><span className="font-medium">备注：</span>{v.notes}</div>}
                  </div>
                ))}
              </div>
            </div>
          </div>
        ))}
      </div>
    </Section>
  );
}

// ====== 6) 文件上传（舌象/脉象）演示组件 ======
function UploadDemo() {
  const [file, setFile] = useState<File | null>(null);
  const [url, setUrl] = useState<string | null>(null);
  const [customerId, setCustomerId] = useState("");

  const upload = async () => {
    if (!file || !customerId) return alert("请选择客户并选择图片");
    const ext = file.name.split(".").pop();
    const path = `${customerId}/${Date.now()}.${ext}`;
    const { error } = await supabase.storage.from("uploads").upload(path, file, { upsert: true });
    if (error) return alert(error.message);
    const { data } = supabase.storage.from("uploads").getPublicUrl(path);
    setUrl(data.publicUrl);
  };

  return (
    <Section title="图片上传（舌象/脉象/报告）">
      <div className="grid md:grid-cols-3 gap-3 items-end">
        <Input label="顾客ID" placeholder="粘贴 customers.id" value={customerId} onChange={(e) => setCustomerId(e.target.value)} />
        <input type="file" accept="image/*" onChange={(e) => setFile(e.target.files?.[0] || null)} />
        <button onClick={upload} className="rounded-xl px-4 py-2 bg-black text-white">上传</button>
      </div>
      {url && (
        <div className="mt-3">
          <div className="text-sm text-gray-600">Public URL：</div>
          <a className="text-blue-600 underline" href={url} target="_blank" rel="noreferrer">{url}</a>
          <div className="mt-2"><img src={url} alt="preview" className="max-h-64 rounded-xl border" /></div>
        </div>
      )}
    </Section>
  );
}

// ====== 7) 顶层 App ======
export default function App() {
  const [tab, setTab] = useState<'intake' | 'admin' | 'upload'>('intake');

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 text-gray-900 p-6 md:p-10">
      <header className="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div>
          <div className="text-2xl font-bold">GenQi · Sabah 门店系统</div>
          <div className="text-sm text-gray-600">www.genqi.vip • sabah.genqi.vip</div>
        </div>
        <nav className="flex items-center gap-2">
          <button onClick={() => setTab('intake')} className={`px-4 py-2 rounded-xl border ${tab==='intake' ? 'bg-black text-white' : ''}`}>问诊表</button>
          <button onClick={() => setTab('admin')} className={`px-4 py-2 rounded-xl border ${tab==='admin' ? 'bg-black text-white' : ''}`}>Admin</button>
          <button onClick={() => setTab('upload')} className={`px-4 py-2 rounded-xl border ${tab==='upload' ? 'bg-black text-white' : ''}`}>上传</button>
        </nav>
      </header>

      <main className="max-w-6xl mx-auto">
        {tab === 'intake' && <IntakeForm />}
        {tab === 'admin' && <AdminPanel />}
        {tab === 'upload' && <UploadDemo />}
      </main>

      <footer className="mt-12 text-center text-xs text-gray-500">
        © {new Date().getFullYear()} GenQi. All rights reserved.
      </footer>
    </div>
  );
}
